<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Antrian</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .form-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .status { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .status-item { text-align: center; padding: 15px; background: #e9ecef; border-radius: 8px; flex: 1; margin: 0 5px; }
        .status-number { font-size: 24px; font-weight: bold; color: #007bff; }
        .queue-list { background: #f8f9fa; padding: 20px; border-radius: 8px; }
        .queue-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #007bff; }
        .queue-number { font-weight: bold; color: #007bff; font-size: 18px; }
        .current-call { background: #28a745; color: white; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sistem Antrian</h1>
        
        <div class="status">
            <div class="status-item">
                <div class="status-number" id="cs1">000</div>
                <div>CS 1</div>
            </div>
            <div class="status-item">
                <div class="status-number" id="cs2">000</div>
                <div>CS 2</div>
            </div>
            <div class="status-item">
                <div class="status-number" id="t1">000</div>
                <div>Teller 1</div>
            </div>
            <div class="status-item">
                <div class="status-number" id="t2">000</div>
                <div>Teller 2</div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Tambah Antrian Baru</h3>
            <div class="form-group">
                <label for="customerName">Nama (Opsional):</label>
                <input type="text" id="customerName" placeholder="Masukkan nama...">
            </div>
            <button onclick="addQueue('cs')" style="background: #27ae60;">Ambil Nomor Customer Service</button>
            <button onclick="addQueue('teller')" style="background: #2980b9;">Ambil Nomor Teller</button>
        </div>
        
        <div class="form-section">
            <h3>Panggil Ulang Nomor</h3>
            <div class="form-group">
                <label for="recallNumber">Nomor Antrian:</label>
                <input type="text" id="recallNumber" placeholder="Contoh: A001 atau B001" maxlength="4">
            </div>
            <button onclick="recallNumber('cs1')" style="background: #27ae60;">Panggil Ulang ke CS 1</button>
            <button onclick="recallNumber('cs2')" style="background: #27ae60;">Panggil Ulang ke CS 2</button>
            <button onclick="recallNumber('t1')" style="background: #2980b9;">Panggil Ulang ke Teller 1</button>
            <button onclick="recallNumber('t2')" style="background: #2980b9;">Panggil Ulang ke Teller 2</button>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="status-number" id="totalCS">0</div>
                <div>Antrian CS</div>
            </div>
            <div class="status-item">
                <div class="status-number" id="totalTeller">0</div>
                <div>Antrian Teller</div>
            </div>
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button onclick="nextQueue('cs1')" style="background: #27ae60;">Panggil ke CS 1</button>
            <button onclick="nextQueue('cs2')" style="background: #27ae60;">Panggil ke CS 2</button>
            <button onclick="nextQueue('t1')" style="background: #2980b9;">Panggil ke Teller 1</button>
            <button onclick="nextQueue('t2')" style="background: #2980b9;">Panggil ke Teller 2</button>
            <button class="danger" onclick="resetQueue()">Reset Antrian</button>
            <a href="/display" target="_blank">
                <button style="background: #6c757d;">Buka Display</button>
            </a>
        </div>
        
        <div class="queue-list">
            <h3>Daftar Antrian</h3>
            <div id="queueList">
                <p>Tidak ada antrian</p>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        socket.on('queueUpdated', (data) => {
            updateQueueDisplay(data);
        });
        
        function updateQueueDisplay(data) {
            document.getElementById('totalCS').textContent = data.totalCS || 0;
            document.getElementById('totalTeller').textContent = data.totalTeller || 0;
            document.getElementById('cs1').textContent = data.counters.cs1.current;
            document.getElementById('cs2').textContent = data.counters.cs2.current;
            document.getElementById('t1').textContent = data.counters.t1.current;
            document.getElementById('t2').textContent = data.counters.t2.current;
            
            const queueList = document.getElementById('queueList');
            const allQueue = [...(data.queueCS || []), ...(data.queueTeller || [])];
            
            if (allQueue.length === 0) {
                queueList.innerHTML = '<p>Tidak ada antrian</p>';
            } else {
                queueList.innerHTML = allQueue.map(item => `
                    <div class="queue-item">
                        <div>
                            <span class="queue-number">${item.number}</span>
                            <span> - ${item.name}</span>
                        </div>
                        <small>${new Date(item.timestamp).toLocaleTimeString()}</small>
                    </div>
                `).join('');
            }
        }
        
        async function addQueue(type) {
            const name = document.getElementById('customerName').value.trim();
            
            try {
                const response = await fetch('/api/add-queue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, name })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('customerName').value = '';
                    const typeName = type === 'teller' ? 'Teller' : 'Customer Service';
                    alert(`Nomor antrian ${typeName}: ${result.queueItem.number}`);
                }
            } catch (error) {
                alert('Gagal menambah antrian');
            }
        }
        
        async function nextQueue(counter) {
            try {
                const response = await fetch('/api/next-queue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ counter })
                });
                const result = await response.json();
                
                if (!result.success) {
                    alert(result.message);
                }
            } catch (error) {
                alert('Gagal memanggil antrian');
            }
        }
        
        async function recallNumber(counter) {
            const numberInput = document.getElementById('recallNumber');
            const number = numberInput.value.trim();
            
            if (!number) {
                alert('Masukkan nomor antrian');
                return;
            }
            
            try {
                const response = await fetch('/api/recall-number', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number: number, counter: counter })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const text = await response.text();
                const result = text ? JSON.parse(text) : {};
                
                if (result.success) {
                    numberInput.value = '';
                    alert(`Nomor ${result.recalled} dipanggil ulang ke Loket ${counter}`);
                } else {
                    alert(result.message || 'Gagal memanggil ulang nomor');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function resetQueue() {
            if (confirm('Yakin ingin reset semua antrian?')) {
                try {
                    const response = await fetch('/api/reset-queue', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const text = await response.text();
                    const result = text ? JSON.parse(text) : {};
                    
                    if (result.success) {
                        alert('Antrian berhasil direset');
                    } else {
                        alert('Gagal reset antrian');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>