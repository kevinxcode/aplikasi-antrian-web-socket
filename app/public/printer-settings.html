<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <title>Pengaturan Printer - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        h1 { color: #333; font-size: 28px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; font-size: 14px; }
        input[type="text"], textarea, select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        .help-text { font-size: 12px; color: #888; margin-top: 5px; }
        .btn { padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #667eea; color: white; width: 100%; }
        .btn-primary:hover { background: #5568d3; }
        .printer-list { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-top: 10px; }
        .printer-item { padding: 10px; margin: 5px 0; background: white; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Pengaturan Printer Struk</h1>
        </div>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
            <div style="font-weight: 600; margin-bottom: 15px;">Preview Struk:</div>
            <div style="background: white; padding: 20px; border: 2px dashed #ddd; border-radius: 8px; font-family: 'Courier New', monospace; text-align: center; max-width: 300px; margin: 0 auto;" id="receiptPreview">
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;" id="previewTitle">BTN Syariah</div>
                <div style="font-size: 12px; margin-bottom: 10px;" id="previewAddress">Jl. Sopo Del No 56 Jakarta Selatan</div>
                <div style="border-top: 1px dashed #333; margin: 10px 0;"></div>
                <div style="font-size: 14px; margin: 10px 0;">Nomor Antrian</div>
                <div style="font-size: 32px; font-weight: bold; margin: 15px 0;">A001</div>
                <div style="font-size: 14px; margin: 10px 0;">CUSTOMER SERVICE</div>
                <div style="font-size: 11px; margin: 10px 0;">Senin, 1 Des 2025 15:00</div>
                <div style="border-top: 1px dashed #333; margin: 10px 0;"></div>
                <div style="font-size: 11px; margin-top: 10px;" id="previewFooter"></div>
            </div>
        </div>

        <form id="printerForm">
            <div class="form-group">
                <label for="title">Judul Struk:</label>
                <input type="text" id="title" name="title" placeholder="BTN Syariah" required>
            </div>

            <div class="form-group">
                <label for="address">Alamat:</label>
                <input type="text" id="address" name="address" placeholder="Jl. Sopo Del No 56 Jakarta Selatan" required>
            </div>

            <div class="form-group">
                <label for="footer_note">Catatan Footer (Opsional):</label>
                <textarea id="footer_note" name="footer_note" placeholder="Terima kasih"></textarea>
            </div>

            <div class="form-group">
                <label for="paper_size">Ukuran Kertas:</label>
                <select id="paper_size" name="paper_size" required>
                    <option value="58mm">58mm (Thermal Kecil)</option>
                    <option value="80mm">80mm (Thermal Besar)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="use_usb_print" name="use_usb_print">
                    Gunakan USB Print Otomatis
                </label>
                <div class="help-text">Print otomatis ke thermal printer USB (server-side)</div>
            </div>

            <div class="form-group">
                <label>Deteksi Printer USB:</label>
                <button type="button" class="btn btn-primary" style="background: #17a2b8; width: 100%;" onclick="detectPrinters()">üîç Deteksi Printer USB</button>
                <div id="printerList" style="margin-top: 10px; display: none;"></div>
            </div>

            <div style="display: flex; gap: 15px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Simpan Pengaturan</button>
                <button type="button" class="btn btn-primary" style="flex: 1; background: #28a745;" onclick="testPrint()">üñ®Ô∏è Test Print</button>
            </div>
        </form>
    </div>

    <script>
        function updatePreview() {
            const title = document.getElementById('title').value || 'BTN Syariah';
            const address = document.getElementById('address').value || 'Jl. Sopo Del No 56 Jakarta Selatan';
            const footer = document.getElementById('footer_note').value || '';
            const paperSize = document.getElementById('paper_size').value || '58mm';
            
            document.getElementById('previewTitle').textContent = title;
            document.getElementById('previewAddress').textContent = address;
            document.getElementById('previewFooter').textContent = footer;
            
            const preview = document.getElementById('receiptPreview');
            preview.style.maxWidth = paperSize === '80mm' ? '400px' : '300px';
        }

        async function loadSettings() {
            const response = await fetch('/api/printer-settings');
            const data = await response.json();
            if (data.success && data.settings) {
                document.getElementById('title').value = data.settings.title || '';
                document.getElementById('address').value = data.settings.address || '';
                document.getElementById('footer_note').value = data.settings.footer || '';
                document.getElementById('paper_size').value = data.settings.paper_size || '58mm';
                document.getElementById('use_usb_print').checked = data.settings.use_usb_print || data.settings.use_qz_tray || false;
                updatePreview();
            }
        }

        document.getElementById('title').addEventListener('input', updatePreview);
        document.getElementById('address').addEventListener('input', updatePreview);
        document.getElementById('footer_note').addEventListener('input', updatePreview);
        document.getElementById('paper_size').addEventListener('change', updatePreview);

        document.getElementById('printerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                title: document.getElementById('title').value,
                address: document.getElementById('address').value,
                footer: document.getElementById('footer_note').value,
                paper_size: document.getElementById('paper_size').value,
                use_usb_print: document.getElementById('use_usb_print').checked
            };
            
            const response = await fetch('/api/printer-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            alert(data.success ? '‚úÖ ' + data.message : '‚ùå ' + data.message);
        });

        async function testPrint() {
            const useUsbPrint = document.getElementById('use_usb_print').checked;
            
            if (useUsbPrint) {
                try {
                    const response = await fetch('/api/print-usb', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            queueNumber: 'A001',
                            queueType: 'cs',
                            customerName: 'Test Print'
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Test print berhasil!');
                    } else {
                        alert('‚ùå Test print gagal: ' + data.message);
                    }
                } catch (error) {
                    alert('‚ùå Error: ' + error.message);
                }
            } else {
                window.open('/print-receipt/A001', '_blank', 'width=300,height=400');
            }
        }

        async function detectPrinters() {
            const printerListDiv = document.getElementById('printerList');
            printerListDiv.innerHTML = '<div style="padding: 10px; text-align: center;">‚è≥ Mendeteksi printer...</div>';
            printerListDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/usb-printers');
                const data = await response.json();
                
                if (data.success && data.printers.length > 0) {
                    let html = '<div class="printer-list"><div style="font-weight: 600; margin-bottom: 10px;">‚úÖ Printer Terdeteksi:</div>';
                    data.printers.forEach(printer => {
                        html += `<div class="printer-item">üñ®Ô∏è ${printer.name}</div>`;
                    });
                    html += '</div>';
                    printerListDiv.innerHTML = html;
                } else {
                    printerListDiv.innerHTML = '<div style="padding: 10px; color: #856404; background: #fff3cd; border-radius: 5px;">‚ö†Ô∏è Tidak ada printer USB yang terdeteksi. Pastikan printer sudah terhubung dan menyala.</div>';
                }
            } catch (error) {
                printerListDiv.innerHTML = '<div style="padding: 10px; color: #721c24; background: #f8d7da; border-radius: 5px;">‚ùå Error: ' + error.message + '</div>';
            }
        }

        loadSettings();
    </script>
</body>
</html>
